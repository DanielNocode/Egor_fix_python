# Отчёт по Telethon-вебхукам Егора (20.02.2026)

## Что было

Оба сервиса (`send_text` на порту 5022, `send_media` на порту 5023) падали с 500-ками. Причины:

- При каждом промахе кэша скрипты заново запрашивали все диалоги у Telegram → Telegram ставил flood wait (блокировка на 15-30 секунд) → за это время копились новые запросы → всё по кругу
- Аккаунт забанен в канале `3760957276` — Telegram перестал отдавать оттуда обновления
- `PersistentTimestampOutdatedError` — внутренние сбои Telegram при синхронизации каналов

## Что исправлено

- Кэш диалогов грузится **один раз при старте** (3978 entity) и **обновляется каждые 30 минут** автоматически
- Убран повторный запрос диалогов при каждом промахе — больше нет flood wait loop
- Добавлен `catch_up=False` — Telethon не пытается синхронизировать пропущенные обновления
- Добавлены endpoint'ы `/health`, `/stats`, `/reload_cache`
- Развёрнут мониторинг-дашборд с SSL

## Что сейчас в логах

| Ситуация | Статус |
|----------|--------|
| Flood wait loop | Исправлено |
| PersistentTimestampOutdated | Безвредно, Telegram-side |
| "Cannot find chat -100XXXXXXXXXX" | Этих чатов нет в диалогах аккаунта |

Ошибки "Cannot find chat" — это **не баг скрипта**. Это значит, что внешняя система (Make/n8n) шлёт запрос на отправку в чат, в котором аккаунт Егора не состоит (кикнули, ушёл, чат удалён). Повторяющиеся ID:

`-1003519196381`, `-1003772791180`, `-1003701558914`, `-1003850591916`, `-1003790384176` и другие.

## Рекомендации для Егора

1. **Проверить чаты** — зайти в Telegram под своим аккаунтом и убедиться, что он состоит во всех чатах, куда идёт отправка. Если нет — либо вступить обратно, либо убрать из автоматизации.
2. **Не рестартить сервисы часто** — каждый рестарт дёргает `iter_dialogs` и может получить flood wait. Между рестартами минимум 10-15 минут.
3. **При добавлении новых чатов** — нажать "Reload Cache" в дашборде или подождать 30 минут (кэш обновится сам).
4. **Канал 3760957276** — аккаунт забанен. Если нужен — разбанить через админа канала.

---

## Дашборд — как пользоваться

**Адрес:** https://rumyantsevdash.other-digital.ru
**Логин:** `admin` / `telethon2026`

### Главный экран — карточки сервисов

Две карточки: `send_text` (порт 5022) и `send_media` (порт 5023). Для каждого:

- **Status** — `active` (зелёная точка) = работает, `inactive`/`failed` (красная) = упал
- **Uptime** — сколько работает с последнего рестарта
- **Memory / CPU** — потребление ресурсов
- **Cache** — сколько чатов в кэше (норма ~3900+)
- **Errors** — счётчик ошибок с момента запуска

### Кнопки управления (на каждой карточке)

- **Start / Stop / Restart** — управление сервисом (Stop попросит подтверждение)
- **Reload Cache** — принудительно обновить кэш диалогов (после добавления в новые чаты)

### Глобальные действия

- **Clear Flood Wait** — останавливает оба сервиса на 5 минут, потом запускает по одному с паузой 60 секунд. Использовать если оба сервиса ловят flood wait
- **Diagnostics** — запускает полную проверку: статус systemd, порты, health endpoint'ы, размер кэша, последние ошибки

### Логи

- Фильтр по сервису: `Both` / `send_text` / `send_media`
- Фильтр по типу: `Errors only` / `Full log`
- Поиск по тексту, фильтр по дате
- Фильтр по типу ошибки: `PersistentTimestamp`, `Cannot resolve`, `FloodWait` и др.
- Автообновление каждые 30 секунд (можно отключить)
- Кнопки **Copy** и **Download** для экспорта

### Health Check History

Внизу — полоска из точек за последние 2 часа. Зелёная = сервис ответил на `/health`, красная = не ответил. Если 3+ красных подряд — появится алерт вверху страницы.
